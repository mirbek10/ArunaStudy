function text(value) {
  return String(value || '').trim();
}

function localized(ru, ky) {
  const ruText = text(ru);
  const kyText = text(ky) || ruText;
  return {
    ru: ruText,
    ky: kyText
  };
}

const FALLBACK_MESSAGES = {
  400: localized('Ошибка в запросе', 'Суроо катасы'),
  401: localized('Требуется авторизация', 'Авторизация талап кылынат'),
  403: localized('Недостаточно прав', 'Укук жетишсиз'),
  404: localized('Ресурс не найден', 'Ресурс табылган жок'),
  409: localized('Конфликт данных', 'Маалыматтар кагылышты'),
  422: localized('Ошибка валидации', 'Валидация катасы'),
  423: localized('Ресурс временно заблокирован', 'Ресурс убактылуу бөгөттөлгөн'),
  503: localized('Сервис временно недоступен', 'Сервис убактылуу жеткиликсиз')
};

const KNOWN_MESSAGES = new Map([
  ['Маршрут не найден', localized('Маршрут не найден', 'Маршрут табылган жок')],
  ['Ошибка в запросе', localized('Ошибка в запросе', 'Суроо катасы')],
  ['Требуется авторизация', localized('Требуется авторизация', 'Авторизация талап кылынат')],
  ['Недостаточно прав', localized('Недостаточно прав', 'Укук жетишсиз')],
  ['Ресурс не найден', localized('Ресурс не найден', 'Ресурс табылган жок')],
  ['Конфликт данных', localized('Конфликт данных', 'Маалыматтар кагылышты')],
  ['Ошибка валидации', localized('Ошибка валидации', 'Валидация катасы')],
  ['Внутренняя ошибка сервера', localized('Внутренняя ошибка сервера', 'Сервердин ички катасы')],
  ['Некорректный JSON в теле запроса', localized('Некорректный JSON в теле запроса', 'Сурам денесиндеги JSON туура эмес')],
  ['База данных MongoDB временно недоступна', localized('База данных MongoDB временно недоступна', 'MongoDB базасы убактылуу жеткиликсиз')],
  ['Урок не найден', localized('Урок не найден', 'Сабак табылган жок')],
  ['Нет доступа к этому уроку', localized('Нет доступа к этому уроку', 'Бул сабакка жетүү жок')],
  ['Урок заблокирован. Сначала завершите предыдущий урок минимум на 80%.', localized('Урок заблокирован. Сначала завершите предыдущий урок минимум на 80%.', 'Сабак бөгөттөлгөн. Адегенде мурунку сабакты 80% дан кем эмес бүтүрүңүз.')],
  ['Модуль не найден', localized('Модуль не найден', 'Модуль табылган жок')],
  ['Раздел не найден', localized('Раздел не найден', 'Бөлүм табылган жок')],
  ['Пользователь не найден', localized('Пользователь не найден', 'Колдонуучу табылган жок')],
  ['Пользователь с таким email уже существует', localized('Пользователь с таким email уже существует', 'Мындай email менен колдонуучу мурунтан бар')],
  ['Неверный email или пароль', localized('Неверный email или пароль', 'Email же пароль туура эмес')],
  ['Отправка не найдена', localized('Отправка не найдена', 'Жөнөтүү табылган жок')],
  ['Доступ к урокам можно менять только для студентов', localized('Доступ к урокам можно менять только для студентов', 'Сабакка жетүү мүмкүнчүлүгүн студенттер үчүн гана өзгөртсө болот')],
  ['Нужно передать хотя бы одно поле', localized('Нужно передать хотя бы одно поле', 'Жок дегенде бир талааны берүү керек')],
  ['Нужно передать ссылку на ответ или текст ответа', localized('Нужно передать ссылку на ответ или текст ответа', 'Жооптун шилтемесин же жооп текстин берүү керек')],
  ['Индекс правильного варианта должен указывать на существующую опцию', localized('Индекс правильного варианта должен указывать на существующую опцию', 'Туура варианттын индекси бар болгон опцияны көрсөтүшү керек')],
  ['Invalid status filter', localized('Некорректный фильтр статуса', 'Статус чыпкасы туура эмес')],
  ['Invalid lessonId', localized('Некорректный lessonId', 'lessonId туура эмес')],
  ['Invalid submissionId', localized('Некорректный submissionId', 'submissionId туура эмес')],
  ['Submission not found', localized('Отправка не найдена', 'Жөнөтүү табылган жок')],
  ['No access to this submission', localized('Нет доступа к этой отправке', 'Бул жөнөтүүгө жетүү жок')]
]);

export function fallbackLocalizedMessage(status = 500) {
  if (status >= 500) {
    return localized('Внутренняя ошибка сервера', 'Сервердин ички катасы');
  }

  return FALLBACK_MESSAGES[status] || FALLBACK_MESSAGES[400];
}

export function localizeMessage(value, status = 500) {
  if (value && typeof value === 'object' && !Array.isArray(value) && ('ru' in value || 'ky' in value)) {
    return localized(value.ru ?? value.ky, value.ky ?? value.ru);
  }

  const normalized = text(value);
  if (!normalized) {
    return fallbackLocalizedMessage(status);
  }

  return KNOWN_MESSAGES.get(normalized) || localized(normalized, normalized);
}
